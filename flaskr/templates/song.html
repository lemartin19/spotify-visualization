{% extends 'base.html' %}

{% block content %}
<form class="pl-3" action="{{ url_for('home') }}">
  <button class="btn btn-outline-light my-2 my-sm-0 my-sch-again-btn" type="submit">search again</button>
</form>

<div class="container-fluid">
  <h2 class="display-2 text-center">{{track.name}}</h2>
  <h3 class="display-4 text-muted text-center">
  {% for artist in track.album.artists %}
  <small>{{artist.name}}</small>{% if not loop.last %}, {% endif %}
  {% endfor %}
  <small>- {{track.album.name}}</small>
  </h3>
  <div>
    {% set keys = ['No key', 'C', 'C#', 'D', 'Eb', 'E', 'F', 'F#', 'G', 'G#', 'A', 'Bb', 'B'] %}
    <div class="row text-center">
      <div class="col-3">
        <h4 style="color: #f8f8f8">Key: <small>{{keys[features.key + 1]}} {% if features.mode %}Major{% else %}Minor{% endif %}</small></h4>
      </div>
      <div class="col-3">
        <h4 style="color: #f8f8f8">Meter: <small>{{features.time_signature}} / 4</small></h4>
      </div>
      <div class="col-3">
        <h4 style="color: #f8f8f8">Tempo: <small>{{features.tempo}} BPM</small></h4>
      </div>
      <div class="col-3">
        <h4 style="color: #f8f8f8">Popularity: <small>{{track.popularity}}%</small></h4>
      </div>
    </div>
  </div>

  <div class="chartjs-size-monitor">
    <canvas id="analysis" class="chartjs-render-monitor"></canvas>
  </div>

  <div class="chartjs-size-monitor">
    <canvas id="features" class="chartjs-render-monitor"></canvas>
  </div>
</div>

<script>
<<<<<<< HEAD
  var line_data = {
    labels: [
      {% for section in analysis.sections %}
        {{section.start|round(0, 'floor')}},
      {% endfor %}
    ],
    datasets: [{
      label: 'Loudness',
      backgroundColor: '#19D7A588',
      borderColor: '#19D7A5',
      data: [
        {% with loudness_max = analysis.sections|map(attribute='loudness')|max %}
        {% for section in analysis.sections %}
          {{loudness_max / section.loudness}}{% if not loop.last %}, {% endif %}
        {% endfor %}
        {% endwith %}
      ],
      fill: false,
      yAxisID: 'y-axis-0'
    }, {
      label: 'Tempo',
      backgroundColor: '#CAF78688',
      borderColor: '#CAF786',
      data: [
        {% with tempo_max = analysis.sections|map(attribute='tempo')|max %}
        {% for section in analysis.sections %}
        {{section.tempo / tempo_max }}{% if not loop.last %}, {% endif %}
        {% endfor %}
        {% endwith %}
      ],
      fill: false,
    }]
  };

=======
>>>>>>> master
  var line_config = {
    data: {
      type: 'line',
      responsive: true,
      labels: [
        {% for section in analysis.sections %}
          {{section.start}},
          {% if loop.last %}{{section.start + section.duration}}{% endif %}
        {% endfor %}],
      datasets: [{
        type: 'line',
        label: 'Loudness',
        xAxisID: 'x-axis-0',
        yAxisID: 'y-axis-0',
        backgroundColor: '#19D7A588',
        borderColor: '#19D7A5',
        data: [
          {% with loudness_max = analysis.sections|map(attribute='loudness')|max %}
          {% for section in analysis.sections %}
            {{loudness_max / section.loudness}}{% if not loop.last %}, {% endif %}
          {% endfor %}
          {% endwith %}
        ],
        fill: false
      }, {
        type: 'line',
        label: 'Tempo',
        xAxisID: 'x-axis-0',
        yAxisID: 'y-axis-0',
        backgroundColor: '#CAF78688',
        borderColor: '#CAF786',
        data: [
          {% with tempo_max = analysis.sections|map(attribute='tempo')|max %}
          {% for section in analysis.sections %}
          {{section.tempo / tempo_max }}{% if not loop.last %}, {% endif %}
          {% endfor %}
          {% endwith %}
        ],
        fill: false
      }, {
        type: 'line',
        label: 'Key',
        backgroundColor: '#C498FF88',
        borderColor: '#C498FF',
        xAxisID: 'x-axis-0',
        yAxisID: 'y-axis-1',
        data: [
          {% for section in analysis.sections %}
            {x: {{section.start}}, y: {{section.key}}}
            {% if not loop.last %}, {% endif %}
          {% endfor %}
        ],
        showLine: false,
        fill: false
      }]},
		options: {
			scales: {
				xAxes: [{
					display: true,
					scaleLabel: {
            display: true,
            labelString: 'Time'},
          xAxisID: 'x-axis-0',
          ticks: {
            callback: function(value, index, values) {
              var min = Math.floor(value / 60);
              var sec = Math.floor(value) % 60;
              if (sec < 10) {
                return "" + min + ":0" + sec;
              }
              return "" + min + ":" + sec;
            }
          }
				}],
				yAxes: [{
					display: true,
					scaleLabel: {
						display: true,
						labelString: 'Value'},
          yAxisID: 'y-axis-0',
          position: 'left'
				}, {
  				display: true,
          ticks: {
            min: -1,
            max: 12,
            stepSize: 1,
            callback: function(value, index, values) {
              var keys = ["C", "C#", "D", "Eb", "E", "F", "F#", "G", "G#", "A", "Bb", "B"];
              return keys[value];
            }
          },
  				scaleLabel: {
            display: true,
            labelString: 'Key'},
          xAxisID: 'y-axis-1',
          position: 'right'
        }]
			}
    }
	};

  // Feature graph
  var radar_config = {
  	type: 'radar',
  	data: {
  	  labels: ['Danceability',
               'Energy',
               'Acousticness',
               'Instrumentalness',
               'Liveness',
               'Valence',
               'Speechiness'],
  	  datasets: [{
  			backgroundColor: '#FF645488',
  			borderColor: '#FF6454',
  			data: [{{features.danceability}},
               {{features.energy}},
               {{features.acousticness}},
               {{features.instrumentalness}},
               {{features.liveness}},
               {{features.valence}},
               {{features.speechiness}}]
  		}]
  	},
  	options: {
      responsive: true,
      tooltips: {
        mode: 'index',
        intersect: false
      },
      hover: {
        mode: 'nearest',
        intersect: true
      },
  		legend: {display: false},
  		title: {display: false},
  		scale: {
        gridLines: {display: true,
                    color: '#444444'},
  			ticks: {beginAtZero: true,
                max: 1.0,
                fontSize: 18,
                color: '#888888',
                showLabelBackdrop: false},
        pointLabels: {fontSize: 22,
                      fontColor: '#aaaaaa'}},

  	}
  };

  window.onload = function() {
    window.myAnalysis = new Chart(document.getElementById('analysis').getContext('2d'), line_config);
  	window.myFeatures = new Chart(document.getElementById('features'), radar_config);
  };
</script>

{% endblock %}
